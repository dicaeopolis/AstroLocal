<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstroLocal - å¤©ä½“è§£ææ ‡æ³¨</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        body { background-color: #0b0f19; color: #e2e8f0; }
        /* ç®€å•çš„æ˜Ÿç©ºèƒŒæ™¯ */
        .stars {
            background-image: 
                radial-gradient(white 1px, transparent 1px),
                radial-gradient(rgba(255,255,255,0.5) 1px, transparent 1px);
            background-size: 50px 50px, 100px 100px;
            background-position: 0 0, 25px 25px;
        }
    </style>
</head>
<body class="min-h-screen stars flex flex-col items-center justify-center p-4">

    <div class="w-full max-w-lg bg-gray-900/90 backdrop-blur-xl rounded-xl shadow-2xl border border-gray-700 overflow-hidden relative">
        
        <!-- è£…é¥°æ€§å…‰æ™• -->
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-75"></div>

        <!-- å¤´éƒ¨ -->
        <div class="p-6 border-b border-gray-800 text-center">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
                ğŸ”­ AstroLocal
            </h1>
            <p class="text-gray-500 text-xs mt-2 uppercase tracking-widest">High Precision Plate Solving</p>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="p-6" id="work-area">
            
            <!-- è¡¨å•åŒºåŸŸ -->
            <!-- æ³¨æ„: id="upload-form" ç”¨äº JS è§¦å‘ -->
            <form id="upload-form" 
                  hx-post="/upload" 
                  hx-encoding="multipart/form-data" 
                  hx-target="#result-area" 
                  class="space-y-5">
                
                <!-- éšè—çš„ GPS å­—æ®µï¼Œç”± JS å¡«å…… -->
                <input type="hidden" name="lat" id="gps-lat">
                <input type="hidden" name="lon" id="gps-lon">

                <!-- æ–‡ä»¶ä¸Šä¼ æ§ä»¶ -->
                <div class="group">
                    <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-52 border-2 border-gray-700 border-dashed rounded-xl cursor-pointer bg-gray-800/50 hover:bg-gray-800 hover:border-blue-500 hover:text-blue-400 transition-all duration-300">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-center">
                            <svg class="w-12 h-12 mb-3 text-gray-500 group-hover:text-blue-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="text-sm text-gray-400"><span class="font-semibold">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span> æˆ–æ‹–æ‹½è‡³æ­¤</p>
                            <p class="text-xs text-gray-600 mt-2">æ”¯æŒ JPG / PNG (å»ºè®® < 20MB)</p>
                        </div>
                        <input id="dropzone-file" name="file" type="file" class="hidden" accept="image/jpeg,image/png" onchange="updateFileName(this)" />
                    </label>
                </div>

                <!-- çŠ¶æ€ä¿¡æ¯æ˜¾ç¤º -->
                <div class="flex justify-between items-end px-1 h-6">
                    <span id="file-name-display" class="text-sm text-blue-300 truncate max-w-[60%]"></span>
                    <span id="geo-status" class="text-xs text-gray-500 font-mono">ç­‰å¾…æ“ä½œ...</span>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <!-- type="button" é˜²æ­¢ç›´æ¥æäº¤ï¼Œå¿…é¡»é€šè¿‡ JS è·å– GPS åå†è§¦å‘ -->
                <button type="button" 
                        id="submit-btn"
                        onclick="handleUpload()"
                        class="w-full text-white bg-gradient-to-r from-blue-700 to-indigo-700 hover:from-blue-600 hover:to-indigo-600 focus:ring-4 focus:ring-blue-900 font-medium rounded-lg text-sm px-5 py-3 text-center transition-all shadow-lg shadow-blue-900/30 disabled:opacity-50 disabled:cursor-not-allowed">
                    è·å–å®šä½å¹¶å¼€å§‹è§£æ
                </button>
            </form>
            
            <!-- ç»“æœ/è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ (HTMX æ›¿æ¢ç›®æ ‡) -->
            <div id="result-area" class="mt-8"></div>
        </div>
    </div>

    <!-- å‰ç«¯é€»è¾‘è„šæœ¬ -->
    <script>
        // 1. æ–‡ä»¶åå›æ˜¾
        function updateFileName(input) {
            const display = document.getElementById('file-name-display');
            if (input.files && input.files.length > 0) {
                display.textContent = "ğŸ“„ " + input.files[0].name;
            } else {
                display.textContent = "";
            }
        }

        // 2. æ ¸å¿ƒä¸Šä¼ é€»è¾‘
        function handleUpload() {
            const fileInput = document.getElementById('dropzone-file');
            const statusLabel = document.getElementById('geo-status');
            const btn = document.getElementById('submit-btn');

            // æ ¡éªŒæ˜¯å¦é€‰äº†æ–‡ä»¶
            if (!fileInput.files || fileInput.files.length === 0) {
                alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼");
                return;
            }

            // é”å®šæŒ‰é’®
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-pulse">æ­£åœ¨è·å– GPS...</span>';
            statusLabel.innerText = "æ­£åœ¨è¯·æ±‚åœ°ç†ä½ç½®æƒé™...";
            statusLabel.className = "text-xs text-yellow-500 font-mono animate-pulse";

            // è¯·æ±‚åœ°ç†ä½ç½®
            if (!navigator.geolocation) {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½ï¼Œæ— æ³•è¿›è¡Œç²¾ç¡®å¤©æ–‡è®¡ç®—ã€‚");
                resetBtn();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                // æˆåŠŸå›è°ƒ
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // å¡«å…¥éšè—å­—æ®µ
                    document.getElementById('gps-lat').value = lat;
                    document.getElementById('gps-lon').value = lon;

                    statusLabel.innerText = `GPSé”å®š: ${lat.toFixed(2)}, ${lon.toFixed(2)}`;
                    statusLabel.className = "text-xs text-green-500 font-mono";
                    
                    btn.innerHTML = "æ­£åœ¨ä¸Šä¼ ...";
                    
                    // è§¦å‘ HTMX æäº¤
                    htmx.trigger('#upload-form', 'submit');
                    
                    // ç¨å¾®å»¶è¿Ÿåé‡ç½®æŒ‰é’®æ–‡å­—(å› ä¸ºHTMXä¼šæ›¿æ¢ä¸‹æ–¹åŒºåŸŸï¼Œä½†è¡¨å•è¿˜åœ¨)
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = "ä¸Šä¼ ä¸‹ä¸€å¼ ";
                    }, 2000);
                },
                // å¤±è´¥å›è°ƒ
                (error) => {
                    let msg = "å®šä½å¤±è´¥";
                    switch(error.code) {
                        case error.PERMISSION_DENIED: msg = "è¯·å…è®¸æµè§ˆå™¨è·å–ä½ç½®æƒé™"; break;
                        case error.POSITION_UNAVAILABLE: msg = "æ— æ³•ç¡®å®šä½ç½®"; break;
                        case error.TIMEOUT: msg = "å®šä½è¯·æ±‚è¶…æ—¶"; break;
                    }
                    alert(msg + "\n\næœ¬ç³»ç»Ÿéœ€è¦ç»çº¬åº¦æ¥è®¡ç®—æ—¶åŒºå’Œåœ°å¹³åæ ‡(Alt/Az)ã€‚");
                    
                    statusLabel.innerText = "å®šä½å¤±è´¥";
                    statusLabel.className = "text-xs text-red-500 font-mono";
                    resetBtn();
                },
                // é€‰é¡¹
                {
                    enableHighAccuracy: true, // å°è¯•ä½¿ç”¨ GPS
                    timeout: 10000,           // 10ç§’è¶…æ—¶
                    maximumAge: 0             // å¼ºåˆ¶ä¸ä½¿ç”¨ç¼“å­˜
                }
            );
        }

        function resetBtn() {
            const btn = document.getElementById('submit-btn');
            btn.disabled = false;
            btn.innerHTML = "è·å–å®šä½å¹¶å¼€å§‹è§£æ";
        }
    </script>

</body>
</html>